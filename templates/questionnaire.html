{% extends "base.html" %}

{% block content %}
<section class="home-details" id="wizard">
  <style>
    /* Scoped to questionnaire wizard to avoid global impact */
    #wizard .card { background:#f8f9fa; border:1px solid #ddd; border-radius:8px; padding:20px; margin: 10px 0; }
    #wizard .wizard-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
    #wizard .wizard-actions { display:flex; gap:10px; }
    #wizard .progress { height:10px; background:#eee; border-radius:6px; overflow:hidden; margin:10px 0 18px; }
    #wizard .progress > .bar { height:100%; width:0%; background:#28a745; transition: width .25s ease; }
    #wizard .steps { margin-top: 8px; }
    #wizard .step { display:none; }
    #wizard .step.active { display:block; }
    #wizard .step h2 { margin-top:0; }
    #wizard .nav-buttons { display:flex; justify-content:space-between; gap:10px; margin-top:16px; }
    #wizard .nav-buttons .left, #wizard .nav-buttons .right { display:flex; gap:10px; }
    #wizard .muted { color:#555; }
    #wizard .radio-group, #wizard .checkbox-group { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; }
    #wizard .inline { display:flex; gap:10px; align-items:center; }
    #wizard .success { text-align:center; padding:30px; }
    #wizard .success h2 { color:#28a745; }
    #wizard .hint { font-size: 13px; color:#666; }
    #wizard label { font-weight: 600; }

    /* Button styles to match task-card global look */
    #wizard .btn {
      display:inline-flex; align-items:center; justify-content:center;
      height:38px; padding:0 14px; border-radius:14px; font-weight:600; font-size:14px;
      border:1px solid #e5e7eb; background:#ffffff; color:#1f2937;
      box-shadow:0 6px 16px rgba(210,153,83,0.14); cursor:pointer;
      transition: background .15s ease, transform .05s ease, box-shadow .15s ease;
      text-decoration:none;
    }
    #wizard .btn:hover { background:#fff7ed; }
    #wizard .btn:active { transform:translateY(1px); }
    #wizard .btn-ghost { background:#ffffff; border:1px solid rgba(0,0,0,0.06); box-shadow:0 6px 16px rgba(210,153,83,0.14); color:#1f2937; }
    #wizard .btn-ghost:hover { background:#fff7ed; }
    #wizard .btn-success-soft { background:#e8f7ee; border:1px solid rgba(16,185,129,0.35); color:#0b2b12; box-shadow:none; }
    #wizard .btn-success-soft:hover { background:#dff3e7; }
  </style>

  <div class="wizard-header">
    <h1>Home Details</h1>
    <div class="wizard-actions">
      <a href="{{ url_for('dashboard') }}" class="btn btn-ghost">Back to Dashboard</a>
    </div>
  </div>

  <div class="card">
    <div class="inline" aria-live="polite">
      <strong id="stepLabel">Step 1 of 6</strong>
      <span class="muted" id="stepTitle">Home Basics</span>
    </div>
    <div class="progress" aria-hidden="true"><div class="bar" id="progressBar"></div></div>

    <form id="questionnaireForm" method="POST">
      <!-- Step 1: Home Basics -->
      <div class="step active" data-title="Home Basics">
        <h2>Step 1: Home Basics</h2>
        <p class="muted">Let’s start with the basics about your home.</p>

        <div class="form-group">
          <label>Is your home a:</label>
          <div class="radio-group">
            <label><input type="radio" name="home_type" value="single_family" required {% if prefill.get('home_type')=='single_family' %}checked{% endif %}> Single-family house</label>
            <label><input type="radio" name="home_type" value="condo_townhome" {% if prefill.get('home_type')=='condo_townhome' %}checked{% endif %}> Condo/Townhome</label>
            <label><input type="radio" name="home_type" value="apartment_owned" {% if prefill.get('home_type')=='apartment_owned' %}checked{% endif %}> Apartment (owned)</label>
          </div>
        </div>

        <div class="form-group">
          <label for="year_built">Year built</label>
          <select id="year_built" name="year_built" required>
            <option value="" disabled {% if not prefill.get('year_built') %}selected{% endif %}>Select decade</option>
            <option value="pre1950" {% if prefill.get('year_built')=='pre1950' %}selected{% endif %}>Before 1950</option>
            <option value="1950s" {% if prefill.get('year_built')=='1950s' %}selected{% endif %}>1950s</option>
            <option value="1960s" {% if prefill.get('year_built')=='1960s' %}selected{% endif %}>1960s</option>
            <option value="1970s" {% if prefill.get('year_built')=='1970s' %}selected{% endif %}>1970s</option>
            <option value="1980s" {% if prefill.get('year_built')=='1980s' %}selected{% endif %}>1980s</option>
            <option value="1990s" {% if prefill.get('year_built')=='1990s' %}selected{% endif %}>1990s</option>
            <option value="2000s" {% if prefill.get('year_built')=='2000s' %}selected{% endif %}>2000s</option>
            <option value="2010s" {% if prefill.get('year_built')=='2010s' %}selected{% endif %}>2010s</option>
            <option value="2020s" {% if prefill.get('year_built')=='2020s' %}selected{% endif %}>2020s</option>
          </select>
          <div class="hint">You can refine later if needed.</div>
        </div>

        <div class="form-group">
          <label>Approximate size:</label>
          <div class="radio-group">
            <label><input type="radio" name="home_size" value="lt_1000" required {% if prefill.get('home_size')=='lt_1000' %}checked{% endif %}> Less than 1,000 sq ft</label>
            <label><input type="radio" name="home_size" value="1000_2000" {% if prefill.get('home_size')=='1000_2000' %}checked{% endif %}> 1,000–2,000 sq ft</label>
            <label><input type="radio" name="home_size" value="2000_3000" {% if prefill.get('home_size')=='2000_3000' %}checked{% endif %}> 2,000–3,000 sq ft</label>
            <label><input type="radio" name="home_size" value="gt_3000" {% if prefill.get('home_size')=='gt_3000' %}checked{% endif %}> 3,000+ sq ft</label>
          </div>
        </div>

        <div class="form-group">
          <label>Do you have a yard/outdoor space?</label>
          <div class="radio-group">
            <label><input type="radio" name="has_yard" value="yes" required {% if prefill.get('has_yard') %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="has_yard" value="no" {% if prefill.get('has_yard') is not none and not prefill.get('has_yard') %}checked{% endif %}> No</label>
          </div>
        </div>

        <div class="form-group">
          <label>Do you have carpet in your home?</label>
          <div class="radio-group">
            <label><input type="radio" name="carpet" value="yes" required {% if prefill.get('carpet')=='yes' %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="carpet" value="no" {% if prefill.get('carpet')=='no' %}checked{% endif %}> No</label>
            <label><input type="radio" name="carpet" value="some" {% if prefill.get('carpet')=='some' %}checked{% endif %}> Some rooms</label>
          </div>
        </div>
      </div>

      <!-- Step 2: Systems & Utilities (placeholder 4–6 questions) -->
      <div class="step" data-title="Key Systems">
        <h2>Step 2: Key Systems</h2>
        <p class="muted">Now, let’s see what systems keep your home running.</p>

        <div class="form-group">
          <label>Heating & Cooling:</label>
          <div class="checkbox-group">
            <label><input type="checkbox" name="has_hvac" {% if prefill.get('has_hvac') %}checked{% endif %}> Central HVAC system</label>
            <label><input type="checkbox" name="has_window_units" {% if prefill.get('has_window_units') %}checked{% endif %}> Window/mini-split units</label>
            <label><input type="checkbox" name="has_radiator_boiler" {% if prefill.get('has_radiator_boiler') %}checked{% endif %}> Radiator/boiler system</label>
            <label><input type="checkbox" name="no_central_hvac" {% if prefill.get('no_central_hvac') %}checked{% endif %}> None</label>
          </div>
        </div>

        <div class="form-group">
          <label>Water System:</label>
          <div class="checkbox-group">
            <label><input type="checkbox" name="has_water_heater" {% if prefill.get('has_water_heater') %}checked{% endif %}> Water heater</label>
            <label><input type="checkbox" name="has_water_softener" {% if prefill.get('has_water_softener') %}checked{% endif %}> Water softener</label>
            <label><input type="checkbox" name="has_well" {% if prefill.get('has_well') %}checked{% endif %}> Well water</label>
            <label><input type="checkbox" name="has_septic" {% if prefill.get('has_septic') %}checked{% endif %}> Septic system</label>
          </div>
        </div>

        <div class="form-group">
          <label>Sump pump?</label>
          <div class="radio-group">
            <label><input type="radio" name="has_sump_pump" value="yes" {% if prefill.get('has_sump_pump') %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="has_sump_pump" value="no" {% if prefill.get('has_sump_pump') is not none and not prefill.get('has_sump_pump') %}checked{% endif %}> No</label>
          </div>
        </div>

        <div class="form-group">
          <label>Fireplace:</label>
          <div class="radio-group">
            <label><input type="radio" name="fireplace_type" value="wood" {% if prefill.get('fireplace_type')=='wood' %}checked{% endif %}> Wood-burning</label>
            <label><input type="radio" name="fireplace_type" value="gas" {% if prefill.get('fireplace_type')=='gas' %}checked{% endif %}> Gas</label>
            <label><input type="radio" name="fireplace_type" value="none" {% if prefill.get('fireplace_type') in [None,'', 'none'] %}checked{% endif %}> None</label>
          </div>
        </div>
      </div>

      <!-- Step 3: Kitchen & Laundry (placeholder) -->
      <div class="step" data-title="Appliances">
        <h2>Step 3: Appliances</h2>
        <p class="muted">Which of these do you have in your home?</p>
        <div class="checkbox-group">
          <label><input type="checkbox" name="has_dishwasher" {% if prefill.get('has_dishwasher') %}checked{% endif %}> Dishwasher</label>
          <label><input type="checkbox" name="has_garbage_disposal" {% if prefill.get('has_garbage_disposal') %}checked{% endif %}> Garbage Disposal</label>
          <label><input type="checkbox" name="has_washer_dryer" {% if prefill.get('has_washer_dryer') %}checked{% endif %}> Washer/Dryer</label>
          <label><input type="checkbox" name="has_refrigerator_ice" {% if prefill.get('has_refrigerator_ice') %}checked{% endif %}> Refrigerator with water/ice dispenser</label>
          <label><input type="checkbox" name="has_range_hood" {% if prefill.get('has_range_hood') %}checked{% endif %}> Range Hood</label>
        </div>
      </div>

      <!-- Step 4: Exterior (placeholder) -->
      <div class="step" data-title="Exterior Features">
        <h2>Step 4: Exterior Features</h2>
        <p class="muted">A few questions about the outside of your home.</p>
        <div class="form-group">
          <label>Gutters</label>
          <div class="radio-group">
            <label><input type="radio" name="has_gutters" value="yes" {% if prefill.get('has_gutters') %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="has_gutters" value="no" {% if prefill.get('has_gutters') is not none and not prefill.get('has_gutters') %}checked{% endif %}> No</label>
          </div>
        </div>
        <div class="form-group">
          <label>Garage</label>
          <div class="radio-group">
            <label><input type="radio" name="garage_type" value="attached" {% if prefill.get('garage_type')=='attached' %}checked{% endif %}> Attached</label>
            <label><input type="radio" name="garage_type" value="detached" {% if prefill.get('garage_type')=='detached' %}checked{% endif %}> Detached</label>
            <label><input type="radio" name="garage_type" value="none" {% if prefill.get('garage_type') in [None,'', 'none'] %}checked{% endif %}> None</label>
          </div>
        </div>
        <div class="form-group">
          <label>Deck or patio</label>
          <div class="radio-group">
            <label><input type="radio" name="has_deck_patio" value="yes" {% if prefill.get('has_deck_patio') %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="has_deck_patio" value="no" {% if prefill.get('has_deck_patio') is not none and not prefill.get('has_deck_patio') %}checked{% endif %}> No</label>
          </div>
        </div>
        <div class="form-group">
          <label>Pool or hot tub</label>
          <div class="radio-group">
            <label><input type="radio" name="has_pool_hot_tub" value="yes" {% if prefill.get('has_pool_hot_tub') %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="has_pool_hot_tub" value="no" {% if prefill.get('has_pool_hot_tub') is not none and not prefill.get('has_pool_hot_tub') %}checked{% endif %}> No</label>
          </div>
        </div>
      </div>

      <!-- Step 5: Safety (placeholder) -->
      <div class="step" data-title="Seasons & Climate">
        <h2>Step 5: Seasons & Climate</h2>
        <p class="muted">Let’s tailor your tasks to your climate.</p>
        <div class="form-group">
          <label>Does it snow/freeze where you live?</label>
          <div class="radio-group">
            <label><input type="radio" name="freezes" value="yes" {% if prefill.get('freezes') %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="freezes" value="no" {% if prefill.get('freezes') is not none and not prefill.get('freezes') %}checked{% endif %}> No</label>
          </div>
        </div>
        <div class="form-group">
          <label>When do you typically consider the start of each season?</label>
          <div class="inline" style="flex-wrap:wrap; gap:14px;">
            <div><label>Spring</label><input type="date" name="season_spring" value="{{ prefill.get('season_spring') or '' }}"></div>
            <div><label>Summer</label><input type="date" name="season_summer" value="{{ prefill.get('season_summer') or '' }}"></div>
            <div><label>Fall</label><input type="date" name="season_autumn" value="{{ prefill.get('season_autumn') or '' }}"></div>
            <div><label>Winter</label><input type="date" name="season_winter" value="{{ prefill.get('season_winter') or '' }}"></div>
          </div>
        </div>
      </div>

      <!-- Step 6: Water & Waste (placeholder) -->
      <div class="step" data-title="Lifestyle & Extras (Optional)">
        <h2>Step 6: Lifestyle & Extras (Optional)</h2>
        <p class="muted">Last step — a couple of extras to make things more personal.</p>
        <div class="form-group">
          <label>Do you have pets?</label>
          <div class="radio-group">
            <label><input type="radio" name="has_pets" value="yes" {% if prefill.get('has_pets') %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="has_pets" value="no" {% if prefill.get('has_pets') is not none and not prefill.get('has_pets') %}checked{% endif %}> No</label>
          </div>
          <div class="inline" style="margin-top:8px; gap:14px;">
            <label><input type="checkbox" name="pet_dog" {% if prefill.get('pet_dog') %}checked{% endif %}> Dog</label>
            <label><input type="checkbox" name="pet_cat" {% if prefill.get('pet_cat') %}checked{% endif %}> Cat</label>
            <label><input type="checkbox" name="pet_other" {% if prefill.get('pet_other') %}checked{% endif %}> Other</label>
          </div>
        </div>
        <div class="form-group">
          <label>Do you travel often or spend extended time away from home?</label>
          <div class="radio-group">
            <label><input type="radio" name="travel_often" value="yes" {% if prefill.get('travel_often') %}checked{% endif %}> Yes</label>
            <label><input type="radio" name="travel_often" value="no" {% if prefill.get('travel_often') is not none and not prefill.get('travel_often') %}checked{% endif %}> No</label>
          </div>
        </div>
      </div>

      <!-- Success screen (shown after final step submit) -->
      <div class="step" id="successStep" data-title="All set!">
        <div class="success">
          <h2>Great! We’ll build your maintenance plan</h2>
          <p class="muted">Hang tight while we prepare tasks tailored to your home.</p>
          <button type="submit" id="finalSubmit" class="btn btn-success-soft">Build my plan</button>
        </div>
      </div>

      <div class="nav-buttons">
        <div class="left">
          <button type="button" id="backBtn" class="btn btn-ghost">Back</button>
        </div>
        <div class="right">
          <button type="button" id="nextBtn" class="btn">Next</button>
        </div>
      </div>
    </form>
  </div>

  <script>
    (function(){
      const form = document.getElementById('questionnaireForm');
      const steps = Array.from(form.querySelectorAll('.step'));
      const successStep = document.getElementById('successStep');
      const backBtn = document.getElementById('backBtn');
      const nextBtn = document.getElementById('nextBtn');
      const stepLabel = document.getElementById('stepLabel');
      const stepTitle = document.getElementById('stepTitle');
      const progressBar = document.getElementById('progressBar');
      const totalSteps = 6; // content steps (exclude success)
      let index = 0; // 0..5 are content steps

      function show(i){
        steps.forEach((s, idx)=>{
          s.classList.toggle('active', idx === i);
        });
        const title = steps[i].dataset.title || '';
        stepLabel.textContent = `Step ${Math.min(i+1, totalSteps)} of ${totalSteps}`;
        stepTitle.textContent = title;
        const pct = Math.min(((i) / totalSteps) * 100, 100);
        progressBar.style.width = pct + '%';
        backBtn.style.visibility = i === 0 ? 'hidden' : 'visible';
        nextBtn.textContent = (i === totalSteps - 1) ? 'Review' : 'Next';
      }

      function goNext(){
        // Validate required fields on current step
        const current = steps[index];
        const required = Array.from(current.querySelectorAll('[required]'));
        for(const el of required){
          if((el.type === 'radio' || el.type === 'checkbox')){
            const named = current.querySelectorAll(`[name="${el.name}"]`);
            if(!Array.from(named).some(n => n.checked)) { el.reportValidity(); return; }
          } else if(!el.value) { el.reportValidity(); return; }
        }

        if(index < totalSteps - 1){
          index++;
          show(index);
        } else {
          // show success step
          index = steps.indexOf(successStep);
          show(index);
          // disable nav when on success
          backBtn.style.visibility = 'hidden';
          nextBtn.style.visibility = 'hidden';
          progressBar.style.width = '100%';
          stepLabel.textContent = 'All set';
          stepTitle.textContent = 'Ready to build your plan';
        }
      }

      function goBack(){
        if(index > 0 && index <= totalSteps - 1){
          index--;
          show(index);
        }
      }

      backBtn.addEventListener('click', goBack);
      nextBtn.addEventListener('click', goNext);
      show(index);
    })();
  </script>
</section>
{% endblock %}