{% extends "base.html" %}

{% block content %}
<section class="home-details" id="wizard">
  

  <div class="wizard-header">
    <h1>Home Details</h1>
    <div class="wizard-actions">
      <a href="{{ url_for('dashboard') }}" class="btn btn-ghost">Back to Dashboard</a>
    </div>
  </div>

  <div class="card">
    <div id="saveError" class="wizard-error"></div>
    <div class="inline" aria-live="polite">
      <strong id="stepLabel">Step 1 of 6</strong>
      <span class="muted" id="stepTitle">Home Basics</span>
    </div>
    <div class="progress" aria-hidden="true"><div class="bar" id="progressBar"></div></div>

    <form id="questionnaireForm" method="POST">
      <!-- Step 0: Persona & Time Commitment -->
      <div class="step active" data-title="Getting Started">
        <h2>Every home (and every homeowner) is different. <br>
            Tell us a bit about where you‚Äôre starting from so we can tailor your task list to match your pace.</h2>
        <p class="muted">This helps us set a calm, right-sized plan for your first weeks.</p>

        <div class="form-group">
          <label>Which best describes you?</label>
          <div class="option-cards">
            <label class="option-card">
              <div class="title">Just Moved In</div>
              <div class="hint">I recently bought my home and want help learning what needs attention first.</div>
              <input type="radio" name="persona" value="buyer" required {%- if prefill.get('persona')=='buyer' -%}checked{%- endif -%}>
            </label>
            <label class="option-card">
              <div class="title">Getting Back on Track</div>
              <div class="hint">I‚Äôve owned my home for a while, but I‚Äôm behind on maintenance and want a manageable way to get things back in shape.</div>
              <input type="radio" name="persona" value="catching_up" {%- if prefill.get('persona')=='catching_up' -%}checked{%- endif -%}>
            </label>
            <label class="option-card">
              <div class="title">Staying Organized</div>
              <div class="hint">I‚Äôve kept up with regular maintenance, but I‚Äôd like a smarter way to track and plan tasks.</div>
              <input type="radio" name="persona" value="on_top" {%- if prefill.get('persona')=='on_top' -%}checked{%- endif -%}>
            </label>
          </div>
        </div>

        <div class="section-divider"></div>

        <div class="form-group">
          <label>How much time do you want to devote to home care each week?</label>
          <div class="option-cards">
            {% set tb = prefill.get('time_budget_minutes_per_week') %}
            <label class="option-card">
              <div class="title">‚è≥ Light Touch</div>
              <div class="hint">about 1 hour/week</div>
              <input type="radio" name="time_budget" value="60" {{ 'checked' if tb==60 }}>
            </label>
            <label class="option-card">
              <div class="title">‚öñÔ∏è Steady Pace</div>
              <div class="hint">around 2‚Äì3 hours/week</div>
              <input type="radio" name="time_budget" value="150" {{ 'checked' if tb==150 }}>
            </label>
            <label class="option-card">
              <div class="title">üí™ Tackle More</div>
              <div class="hint">4+ hours/week</div>
              <input type="radio" name="time_budget" value="240" {{ 'checked' if tb==240 }}>
            </label>
            <label class="option-card">
              <div class="title">Not sure yet</div>
              <div class="hint">We‚Äôll set a gentle default, you can change this later.</div>
              <input type="radio" name="time_budget" value="" {{ 'checked' if not tb }}>
            </label>
          </div>
        </div>
      </div>

      <!-- Step 1: Home Basics -->
      <div class="step" data-title="Home Basics">
        <h2>Step 1: Home Basics</h2>
        <p class="muted">Let‚Äôs start with the basics about your home. Don't worry if you don't know the answer, we'll use the default and you can always come back and edit later.</p>

        <div class="form-group">
          <label>Is your home a:</label>
          <div class="option-cards" id="homeTypeOptions">
            <label class="option-card" data-value="single_family">
              <svg class="icon" aria-hidden="true"><use href="#icon-house"></use></svg>
              <div class="title">Single-family house</div>
              <input type="radio" name="home_type" value="single_family" required {% if prefill.get('home_type')=='single_family' %}checked{% endif %}>
            </label>
            <label class="option-card" data-value="condo_townhome">
              <svg class="icon" aria-hidden="true"><use href="#icon-townhouse"></use></svg>
              <div class="title">Condo/Townhome</div>
              <input type="radio" name="home_type" value="condo_townhome" {% if prefill.get('home_type')=='condo_townhome' %}checked{% endif %}>
            </label>
            <label class="option-card" data-value="apartment_owned">
              <svg class="icon" aria-hidden="true"><use href="#icon-apartment"></use></svg>
              <div class="title">Apartment (owned)</div>
              <input type="radio" name="home_type" value="apartment_owned" {% if prefill.get('home_type')=='apartment_owned' %}checked{% endif %}>
            </label>
          </div>
        </div>

        <div class="section-divider"></div>

        <div class="form-group">
          <label for="year_built">Year built</label>
          <select id="year_built" name="year_built" required>
            <option value="" disabled {% if not prefill.get('year_built') %}selected{% endif %}>Select decade</option>
            <option value="pre1950" {% if prefill.get('year_built')=='pre1950' %}selected{% endif %}>Before 1950</option>
            <option value="1950s" {% if prefill.get('year_built')=='1950s' %}selected{% endif %}>1950s</option>
            <option value="1960s" {% if prefill.get('year_built')=='1960s' %}selected{% endif %}>1960s</option>
            <option value="1970s" {% if prefill.get('year_built')=='1970s' %}selected{% endif %}>1970s</option>
            <option value="1980s" {% if prefill.get('year_built')=='1980s' %}selected{% endif %}>1980s</option>
            <option value="1990s" {% if prefill.get('year_built')=='1990s' %}selected{% endif %}>1990s</option>
            <option value="2000s" {% if prefill.get('year_built')=='2000s' %}selected{% endif %}>2000s</option>
            <option value="2010s" {% if prefill.get('year_built')=='2010s' %}selected{% endif %}>2010s</option>
            <option value="2020s" {% if prefill.get('year_built')=='2020s' %}selected{% endif %}>2020s</option>
          </select>
        </div>

        <div class="form-group">
          <label>Approximate size:</label>
          <div class="option-cards">
            <label class="option-card"><div class="title">Less than 1,000 sq ft</div>
              <input type="radio" name="home_size" value="lt_1000" required {% if prefill.get('home_size')=='lt_1000' %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">1,000‚Äì2,000 sq ft</div>
              <input type="radio" name="home_size" value="1000_2000" {% if prefill.get('home_size')=='1000_2000' %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">2,000‚Äì3,000 sq ft</div>
              <input type="radio" name="home_size" value="2000_3000" {% if prefill.get('home_size')=='2000_3000' %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">3,000+ sq ft</div>
              <input type="radio" name="home_size" value="gt_3000" {% if prefill.get('home_size')=='gt_3000' %}checked{% endif %}>
            </label>
          </div>
          <div class="hint">Rough estimates are okay.</div>
        </div>

        <div class="form-group">
          <label>Do you have a yard/outdoor space?</label>
          <div class="option-cards">
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-check"></use></svg><div class="title">Yes</div>
              <input type="radio" name="has_yard" value="yes" required {% if prefill.get('has_yard') %}checked{% endif %}>
            </label>
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-x"></use></svg><div class="title">No</div>
              <input type="radio" name="has_yard" value="no" {% if prefill.get('has_yard') is not none and not prefill.get('has_yard') %}checked{% endif %}>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>Do you have carpet in your home?</label>
          <div class="option-cards">
            <label class="option-card"><div class="title">Yes</div>
              <input type="radio" name="carpet" value="yes" required {% if prefill.get('carpet')=='yes' %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">No</div>
              <input type="radio" name="carpet" value="no" {% if prefill.get('carpet')=='no' %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">Some rooms</div>
              <input type="radio" name="carpet" value="some" {% if prefill.get('carpet')=='some' %}checked{% endif %}>
            </label>
          </div>
        </div>
      </div>

      <!-- Step 2: Systems & Utilities (placeholder 4‚Äì6 questions) -->
      <div class="step" data-title="Key Systems">
        <h2>Step 2: Key Systems</h2>
        <p class="muted">Now, let‚Äôs see what systems keep your home running.</p>

        <div class="form-group">
          <label>Heating & Cooling:</label>
          <div class="option-cards">
            <label class="option-card"><div class="title">Central HVAC system</div>
              <input type="checkbox" name="has_hvac" {% if prefill.get('has_hvac') %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">Window/mini-split units</div>
              <input type="checkbox" name="has_window_units" {% if prefill.get('has_window_units') %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">Radiator/boiler system</div>
              <input type="checkbox" name="has_radiator_boiler" {% if prefill.get('has_radiator_boiler') %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">None</div>
              <input type="checkbox" name="no_central_hvac" {% if prefill.get('no_central_hvac') %}checked{% endif %}>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>Water System:</label>
          <div class="option-cards">
            <label class="option-card"><div class="title">Water heater</div>
              <input type="checkbox" name="has_water_heater" {% if prefill.get('has_water_heater') %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">Water softener</div>
              <input type="checkbox" name="has_water_softener" {% if prefill.get('has_water_softener') %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">Well water</div>
              <input type="checkbox" name="has_well" {% if prefill.get('has_well') %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">Septic system</div>
              <input type="checkbox" name="has_septic" {% if prefill.get('has_septic') %}checked{% endif %}>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>Sump pump?</label>
          <div class="option-cards">
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-check"></use></svg><div class="title">Yes</div>
              <input type="radio" name="has_sump_pump" value="yes" {% if prefill.get('has_sump_pump') %}checked{% endif %}>
            </label>
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-x"></use></svg><div class="title">No</div>
              <input type="radio" name="has_sump_pump" value="no" {% if prefill.get('has_sump_pump') is not none and not prefill.get('has_sump_pump') %}checked{% endif %}>
            </label>
          </div>
          <div class="hint">Basements in wetter areas often have one.</div>
        </div>

        <div class="form-group">
          <label>Fireplace:</label>
          <div class="option-cards">
            <label class="option-card"><div class="title">Wood-burning</div>
              <input type="radio" name="fireplace_type" value="wood" {% if prefill.get('fireplace_type')=='wood' %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">Gas</div>
              <input type="radio" name="fireplace_type" value="gas" {% if prefill.get('fireplace_type')=='gas' %}checked{% endif %}>
            </label>
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-x"></use></svg><div class="title">None</div>
              <input type="radio" name="fireplace_type" value="none" {% if prefill.get('fireplace_type') in [None,'', 'none'] %}checked{% endif %}>
            </label>
          </div>
        </div>
      </div>

      <!-- Step 3: Kitchen & Laundry (placeholder) -->
      <div class="step" data-title="Appliances">
        <h2>Step 3: Appliances</h2>
        <p class="muted">Which of these do you have in your home?</p>
        <div class="option-cards">
          <label class="option-card"><div class="title">Dishwasher</div>
            <input type="checkbox" name="has_dishwasher" {% if prefill.get('has_dishwasher') %}checked{% endif %}>
          </label>
          <label class="option-card"><div class="title">Garbage Disposal</div>
            <input type="checkbox" name="has_garbage_disposal" {% if prefill.get('has_garbage_disposal') %}checked{% endif %}>
          </label>
          <label class="option-card"><div class="title">Washer/Dryer</div>
            <input type="checkbox" name="has_washer_dryer" {% if prefill.get('has_washer_dryer') %}checked{% endif %}>
          </label>
          <label class="option-card"><div class="title">Refrigerator with water/ice dispenser</div>
            <input type="checkbox" name="has_refrigerator_ice" {% if prefill.get('has_refrigerator_ice') %}checked{% endif %}>
          </label>
          <label class="option-card"><div class="title">Range Hood</div>
            <input type="checkbox" name="has_range_hood" {% if prefill.get('has_range_hood') %}checked{% endif %}>
          </label>
        </div>
      </div>

      <!-- Step 4: Exterior (placeholder) -->
      <div class="step" data-title="Exterior Features">
        <h2>Step 4: Exterior Features</h2>
        <p class="muted">A few questions about the outside of your home.</p>
        <div class="form-group">
          <label>Gutters</label>
          <div class="option-cards">
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-check"></use></svg><div class="title">Yes</div>
              <input type="radio" name="has_gutters" value="yes" {% if prefill.get('has_gutters') %}checked{% endif %}>
            </label>
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-x"></use></svg><div class="title">No</div>
              <input type="radio" name="has_gutters" value="no" {% if prefill.get('has_gutters') is not none and not prefill.get('has_gutters') %}checked{% endif %}>
            </label>
          </div>
        </div>
        <div class="form-group">
          <label>Garage</label>
          <div class="option-cards">
            <label class="option-card"><div class="title">Attached</div>
              <input type="radio" name="garage_type" value="attached" {% if prefill.get('garage_type')=='attached' %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">Detached</div>
              <input type="radio" name="garage_type" value="detached" {% if prefill.get('garage_type')=='detached' %}checked{% endif %}>
            </label>
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-x"></use></svg><div class="title">None</div>
              <input type="radio" name="garage_type" value="none" {% if prefill.get('garage_type') in [None,'', 'none'] %}checked{% endif %}>
            </label>
          </div>
        </div>
        <div class="form-group">
          <label>Deck or patio</label>
          <div class="option-cards">
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-check"></use></svg><div class="title">Yes</div>
              <input type="radio" name="has_deck_patio" value="yes" {% if prefill.get('has_deck_patio') %}checked{% endif %}>
            </label>
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-x"></use></svg><div class="title">No</div>
              <input type="radio" name="has_deck_patio" value="no" {% if prefill.get('has_deck_patio') is not none and not prefill.get('has_deck_patio') %}checked{% endif %}>
            </label>
          </div>
        </div>
        <div class="form-group">
          <label>Pool or hot tub</label>
          <div class="option-cards">
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-check"></use></svg><div class="title">Yes</div>
              <input type="radio" name="has_pool_hot_tub" value="yes" {% if prefill.get('has_pool_hot_tub') %}checked{% endif %}>
            </label>
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-x"></use></svg><div class="title">No</div>
              <input type="radio" name="has_pool_hot_tub" value="no" {% if prefill.get('has_pool_hot_tub') is not none and not prefill.get('has_pool_hot_tub') %}checked{% endif %}>
            </label>
          </div>
        </div>
      </div>

      <!-- Step 5: Safety (placeholder) -->
      <div class="step" data-title="Seasons & Climate">
        <h2>Step 5: Seasons & Climate</h2>
        <p class="muted">Let‚Äôs tailor your tasks to your climate.</p>
        <div class="form-group">
          <label>Does it snow/freeze where you live?</label>
          <div class="option-cards">
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-check"></use></svg><div class="title">Yes</div>
              <input type="radio" name="freezes" value="yes" {% if prefill.get('freezes') %}checked{% endif %}>
            </label>
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-x"></use></svg><div class="title">No</div>
              <input type="radio" name="freezes" value="no" {% if prefill.get('freezes') is not none and not prefill.get('freezes') %}checked{% endif %}>
            </label>
          </div>
        </div>
        <div class="form-group season-selector">
          <label>When do you typically consider the start of each season?</label>
          <div class="inline inline-wrap">
            {% set sp = (prefill.get('season_spring') or '') %}
            {% set su = (prefill.get('season_summer') or '') %}
            {% set fa = (prefill.get('season_autumn') or '') %}
            {% set wi = (prefill.get('season_winter') or '') %}

            <div>
              <label>Spring</label>
              <select name="season_spring">
                {% set mm = '03' %}
                {% set selected = ('-' ~ mm ~ '-') in sp or sp == mm or sp|lower == 'march' %}
                <option value="03" {{ 'selected' if selected }}>March</option>
                <option value="04" {{ 'selected' if sp in ['04', 'april', 'April'] or ('-04-') in sp }}>April</option>
              </select>
            </div>

            <div>
              <label>Summer</label>
              <select name="season_summer">
                <option value="06" {{ 'selected' if su in ['06', 'june', 'June'] or ('-06-') in su }}>June</option>
                <option value="07" {{ 'selected' if su in ['07', 'july', 'July'] or ('-07-') in su }}>July</option>
              </select>
            </div>

            <div>
              <label>Fall</label>
              <select name="season_autumn">
                <option value="09" {{ 'selected' if fa in ['09', 'september', 'September'] or ('-09-') in fa }}>September</option>
                <option value="10" {{ 'selected' if fa in ['10', 'october', 'October'] or ('-10-') in fa }}>October</option>
              </select>
            </div>

            <div>
              <label>Winter</label>
              <select name="season_winter">
                <option value="12" {{ 'selected' if wi in ['12', 'december', 'December'] or ('-12-') in wi }}>December</option>
                <option value="01" {{ 'selected' if wi in ['01', 'january', 'January'] or ('-01-') in wi }}>January</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 6: Water & Waste (placeholder) -->
      <div class="step" data-title="Lifestyle & Extras (Optional)">
        <h2>Step 6: Lifestyle & Extras (Optional)</h2>
        <p class="muted">Last step ‚Äî a couple of extras to make things more personal.</p>
        <div class="form-group">
          <label>Do you have pets?</label>
          <div class="option-cards">
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-check"></use></svg><div class="title">Yes</div>
              <input type="radio" name="has_pets" value="yes" {% if prefill.get('has_pets') %}checked{% endif %}>
            </label>
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-x"></use></svg><div class="title">No</div>
              <input type="radio" name="has_pets" value="no" {% if prefill.get('has_pets') is not none and not prefill.get('has_pets') %}checked{% endif %}>
            </label>
          </div>
          <div class="section-sub">What kinds?</div>
          <div class="option-cards">
            <label class="option-card"><div class="title">Dog</div>
              <input type="checkbox" name="pet_dog" {% if prefill.get('pet_dog') %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">Cat</div>
              <input type="checkbox" name="pet_cat" {% if prefill.get('pet_cat') %}checked{% endif %}>
            </label>
            <label class="option-card"><div class="title">Other</div>
              <input type="checkbox" name="pet_other" {% if prefill.get('pet_other') %}checked{% endif %}>
            </label>
          </div>
        </div>
        <div class="form-group">
          <label>Do you travel often or spend extended time away from home?</label>
          <div class="option-cards">
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-check"></use></svg><div class="title">Yes</div>
              <input type="radio" name="travel_often" value="yes" {% if prefill.get('travel_often') %}checked{% endif %}>
            </label>
            <label class="option-card"><svg class="icon" aria-hidden="true"><use href="#icon-x"></use></svg><div class="title">No</div>
              <input type="radio" name="travel_often" value="no" {% if prefill.get('travel_often') is not none and not prefill.get('travel_often') %}checked{% endif %}>
            </label>
          </div>
        </div>
      </div>

      <!-- Success screen (shown after final step submit) -->
      <div class="step" id="successStep" data-title="All set!">
        <div class="success">
          <h2>Great! We‚Äôll build your maintenance plan</h2>
          <p class="muted">Hang tight while we prepare tasks tailored to your home.</p>
          <button type="submit" id="finalSubmit" class="btn btn-success-soft">Build my plan</button>
        </div>
      </div>

      <div class="nav-buttons">
        <div class="left">
          <button type="button" id="backBtn" class="btn btn-ghost">Back</button>
        </div>
        <div class="right">
          <button type="button" id="nextBtn" class="btn">Next</button>
        </div>
      </div>
    </form>
  </div>

  <script>
    (function(){
      const form = document.getElementById('questionnaireForm');
      const steps = Array.from(form.querySelectorAll('.step'));
      const successStep = document.getElementById('successStep');
      const backBtn = document.getElementById('backBtn');
      const nextBtn = document.getElementById('nextBtn');
      const stepLabel = document.getElementById('stepLabel');
      const stepTitle = document.getElementById('stepTitle');
      const progressBar = document.getElementById('progressBar');
      const totalSteps = 7; // content steps (exclude success)
      let index = 0; // 0..6 are content steps

      function show(i){
        steps.forEach((s, idx)=>{
          s.classList.toggle('active', idx === i);
        });
        const title = steps[i].dataset.title || '';
        stepLabel.textContent = `Step ${Math.min(i+1, totalSteps)} of ${totalSteps}`;
        stepTitle.textContent = title;
        const pct = Math.min(((i) / totalSteps) * 100, 100);
        progressBar.style.width = pct + '%';
        backBtn.style.visibility = i === 0 ? 'hidden' : 'visible';
        nextBtn.textContent = (i === totalSteps - 1) ? 'Review' : 'Next';
      }

      function goNext(){
        // Validate required fields on current step
        const current = steps[index];
        const required = Array.from(current.querySelectorAll('[required]'));
        for(const el of required){
          if((el.type === 'radio' || el.type === 'checkbox')){
            const named = current.querySelectorAll(`[name="${el.name}"]`);
            if(!Array.from(named).some(n => n.checked)) { el.reportValidity(); return; }
          } else if(!el.value) { el.reportValidity(); return; }
        }

        if(index < totalSteps - 1){
          index++;
          show(index);
        } else {
          // show success step
          index = steps.indexOf(successStep);
          show(index);
          // disable nav when on success
          backBtn.style.visibility = 'hidden';
          nextBtn.style.visibility = 'hidden';
          progressBar.style.width = '100%';
          stepLabel.textContent = 'All set';
          stepTitle.textContent = 'Ready to build your plan';
        }
      }

      function goBack(){
        if(index > 0 && index <= totalSteps - 1){
          index--;
          show(index);
        }
      }

      // Icon/text option cards: apply selected state for all groups and tie to radios/checkboxes
      function initOptionCards(){
        const groups = Array.from(document.querySelectorAll('#wizard .option-cards'));
        groups.forEach(group => {
          const cards = Array.from(group.querySelectorAll('.option-card'));
          const updateSelected = () => {
            cards.forEach(card => {
              const input = card.querySelector('input[type="radio"], input[type="checkbox"]');
              card.classList.toggle('selected', !!input && input.checked);
            });
          };
          // Initial state (prefill)
          updateSelected();
          // Click handling
          cards.forEach(card => {
            card.addEventListener('click', (e) => {
              const input = card.querySelector('input[type="radio"], input[type="checkbox"]');
              if(!input) return;
              if(input.type === 'radio'){
                input.checked = true;
              } else if(input.type === 'checkbox') {
                input.checked = !input.checked;
              }
              updateSelected();
            });
          });
        });
      }

      backBtn.addEventListener('click', goBack);
      nextBtn.addEventListener('click', goNext);
      initOptionCards();
      show(index);

      // AJAX submit with inline error messaging
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const errBox = document.getElementById('saveError');
        if(errBox){ errBox.style.display='none'; errBox.textContent=''; }
        try {
          const fd = new FormData(form);
          const res = await fetch(`${window.location.origin}${form.getAttribute('action') || '/questionnaire'}`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
            body: fd,
          });
          const text = await res.text();
          let data = null; try { data = JSON.parse(text); } catch(_) {}
          if(res.ok && data && data.ok){
            window.location.href = data.redirect || '/dashboard';
            return;
          }
          const msg = (data && data.error) || `Save failed (${res.status})`;
          if(errBox){ errBox.textContent = msg; errBox.style.display = 'block'; }
        } catch(err){
          const errBox2 = document.getElementById('saveError');
          if(errBox2){ errBox2.textContent = 'Save failed. Please try again.'; errBox2.style.display='block'; }
        }
      });
    })();
  </script>
</section>
{% endblock %}