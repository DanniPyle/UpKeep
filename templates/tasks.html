{% extends "base.html" %}

{% block content %}
<div class="page-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 4px 0 10px 0;">
  <h1 style="font-size:28px; line-height:1.2; letter-spacing:-0.02em; margin:0; color: var(--raisin-black);">
    {% if filter_date %}
      Tasks for {{ filter_date.strftime('%B %d, %Y') }}
    {% else %}
      Task Board
    {% endif %}
  </h1>
  <div style="display:flex; gap:8px; align-items:center;">
    {% if filter_date %}
      <a class="btn ghost" href="{{ url_for('task_list') }}">View All Tasks</a>
    {% endif %}
    <a class="btn ghost" href="{{ url_for('dashboard') }}">Back to Dashboard</a>
  </div>
</div>

<!-- Search and Filter Bar -->
<div style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
  <form method="get" action="{{ url_for('task_list') }}" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
    <input type="search" name="q" placeholder="Search tasks..." value="{{ request.args.get('q','') }}" style="flex:1; min-width:200px;" />
    <label style="display:inline-flex; align-items:center; gap:6px; font-size: 14px;">
      <input type="checkbox" name="show_archived" value="true" {% if show_archived %}checked{% endif %} onchange="this.form.submit()" />
      Show archived
    </label>
    <button class="btn" type="submit">Search</button>
  </form>
</div>

{% if filter_date %}
<!-- Date Filtered View - Single Column -->
<div class="date-filtered-view">
  <div class="panel-card">
    <h3 class="panel-title">{{ date_filtered_tasks|length }} task{{ 's' if date_filtered_tasks|length != 1 else '' }} due</h3>
    {% if date_filtered_tasks %}
      <div class="task-list-simple">
        {% for t in date_filtered_tasks %}
          {% include 'partials/kanban_card.html' %}
        {% endfor %}
      </div>
    {% else %}
      <p class="empty-state">No tasks due on this date.</p>
    {% endif %}
  </div>
</div>
{% else %}
<!-- Kanban Board -->
<div class="kanban-board">
  <!-- Overdue Column -->
  <div class="kanban-column overdue">
    <div class="column-header">
      <h3 class="column-title">
        <svg class="icon" style="color: #d92d20;" aria-hidden="true"><use href="#icon-alert"></use></svg>
        Overdue
      </h3>
      <span class="count-badge">{{ overdue_tasks|length }}</span>
    </div>
    <div class="kanban-cards">
      {% if overdue_tasks %}
        {% for t in overdue_tasks %}
          {% include 'partials/kanban_card.html' %}
        {% endfor %}
      {% else %}
        <p class="empty-state">No overdue tasks</p>
      {% endif %}
    </div>
  </div>

  <!-- This Week Column -->
  <div class="kanban-column this-week">
    <div class="column-header">
      <h3 class="column-title">
        <svg class="icon" style="color: #f79009;" aria-hidden="true"><use href="#icon-calendar"></use></svg>
        This Week
      </h3>
      <span class="count-badge">{{ this_week_tasks|length }}</span>
    </div>
    <div class="kanban-cards">
      {% if this_week_tasks %}
        {% for t in this_week_tasks %}
          {% include 'partials/kanban_card.html' %}
        {% endfor %}
      {% else %}
        <p class="empty-state">Nothing due this week</p>
      {% endif %}
    </div>
  </div>

  <!-- This Month Column -->
  <div class="kanban-column this-month">
    <div class="column-header">
      <h3 class="column-title">
        <svg class="icon" style="color: #17b26a;" aria-hidden="true"><use href="#icon-calendar"></use></svg>
        This Month
      </h3>
      <span class="count-badge">{{ this_month_tasks|length }}</span>
    </div>
    <div class="kanban-cards">
      {% if this_month_tasks %}
        {% for t in this_month_tasks %}
          {% include 'partials/kanban_card.html' %}
        {% endfor %}
      {% else %}
        <p class="empty-state">Nothing else this month</p>
      {% endif %}
    </div>
  </div>

  <!-- Later Column -->
  <div class="kanban-column later">
    <div class="column-header">
      <h3 class="column-title">
        <svg class="icon" style="color: #7a8a94;" aria-hidden="true"><use href="#icon-calendar"></use></svg>
        Later
      </h3>
      <span class="count-badge">{{ later_tasks|length }}</span>
    </div>
    <div class="kanban-cards">
      {% if later_tasks %}
        {% for t in later_tasks %}
          {% include 'partials/kanban_card.html' %}
        {% endfor %}
      {% else %}
        <p class="empty-state">No future tasks</p>
      {% endif %}
    </div>
  </div>

  <!-- Completed Column (if showing completed) -->
  {% if show_completed %}
  <div class="kanban-column completed">
    <div class="column-header">
      <h3 class="column-title">
        <svg class="icon" style="color: #17b26a;" aria-hidden="true"><use href="#icon-check"></use></svg>
        Completed
      </h3>
      <span class="count-badge">{{ completed_tasks|length }}</span>
    </div>
    <div class="kanban-cards">
      {% if completed_tasks %}
        {% for t in completed_tasks %}
          {% include 'partials/kanban_card.html' %}
        {% endfor %}
      {% else %}
        <p class="empty-state">No completed tasks</p>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>
{% endif %}

<style>
.date-filtered-view {
  max-width: 800px;
  margin: 0 auto;
}

.task-list-simple {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 12px;
  padding: 16px 0;
}

.kanban-board {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

.kanban-column {
  background: #f9fafb;
  border-radius: 8px;
  padding: 12px;
  min-height: 400px;
  min-width: 0; /* Allow columns to shrink below content width */
  display: flex;
  flex-direction: column;
}

.column-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid #e5e7eb;
}

.column-title {
  font-size: 16px;
  font-weight: 600;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--raisin-black);
}

.count-badge {
  background: #e5e7eb;
  color: #374151;
  font-size: 12px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 12px;
  min-width: 24px;
  text-align: center;
}

.kanban-cards {
  display: flex;
  flex-direction: column;
  gap: 8px;
  flex: 1;
  overflow-y: auto;
  max-height: calc(100vh - 300px);
}

.kanban-cards::-webkit-scrollbar {
  width: 6px;
}

.kanban-cards::-webkit-scrollbar-track {
  background: transparent;
}

.kanban-cards::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 3px;
}

.empty-state {
  color: #9ca3af;
  font-size: 14px;
  text-align: center;
  padding: 24px 12px;
  font-style: italic;
}

@media (max-width: 1200px) {
  .kanban-board {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .kanban-board {
    grid-template-columns: 1fr;
  }
}
</style>
{% endblock %}

{% block scripts %}
<!-- Reuse the same simple modals and handlers as dashboard page -->
<div id="history-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Task History</h3>
      <button id="close-history" type="button">Close</button>
    </div>
    <div id="history-body" class="modal-body"></div>
  </div>
  <div class="modal-backdrop"></div>
</div>

<div id="edit-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Task</h3>
      <button id="edit-cancel" type="button">Close</button>
    </div>
    <div class="modal-body">
      <form id="edit-form">
        <div class="form-row">
          <label for="edit-title">Title</label>
          <input type="text" id="edit-title" required />
          <div class="error-text" id="edit-title-error"></div>
        </div>
        <div class="form-row">
          <label for="edit-description">Description</label>
          <textarea id="edit-description" rows="3"></textarea>
        </div>
        <div class="form-row">
          <label for="edit-frequency">Frequency (days)</label>
          <input type="number" id="edit-frequency" min="1" required />
          <div class="error-text" id="edit-frequency-error"></div>
        </div>
        <div class="form-row">
          <label for="edit-due-date">Due date</label>
          <input type="date" id="edit-due-date" />
        </div>
        <div class="form-row">
          <label for="edit-priority">Priority</label>
          <select id="edit-priority">
            <option value="">None</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        <div class="form-row">
          <label for="edit-category">Category</label>
          <input type="text" id="edit-category" />
        </div>
      </form>
    </div>
    <div class="modal-actions">
      <button id="edit-save" type="button">Save</button>
      <button id="edit-delete" type="button" class="btn-ghost" style="margin-left: 8px; color:#b42318; border-color: rgba(180,35,24,0.25);">Delete</button>
    </div>
  </div>
  <div class="modal-backdrop"></div>
</div>

<script>
(function(){
  const $ = (sel, root=document) => root.querySelector(sel);
  const historyModal = $('#history-modal');
  const historyBody = $('#history-body');
  const editModal = $('#edit-modal');
  let currentEditTaskId = null;

  function open(el){ if(el){ el.style.display='flex'; document.body.style.overflow='hidden'; } }
  function close(el){ if(el){ el.style.display='none'; document.body.style.overflow=''; } }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('a,button');
    if(!btn) return;

    if(btn.classList.contains('history-btn')){
      e.preventDefault();
      const taskId = btn.getAttribute('data-task-id');
      historyBody.innerHTML = '<p>Loading history…</p>';
      open(historyModal);
      fetch(`/tasks/${taskId}/history`, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
        .then(r => r.ok ? r.text() : Promise.reject(new Error('Failed to load')))
        .then(html => { historyBody.innerHTML = html; })
        .catch(() => { historyBody.innerHTML = '<p>Unable to load history right now.</p>'; });
    }

    if(btn.classList.contains('edit-btn')){
      e.preventDefault();
      currentEditTaskId = btn.getAttribute('data-task-id');
      $('#edit-title').value = btn.getAttribute('data-title') || '';
      $('#edit-description').value = btn.getAttribute('data-description') || '';
      $('#edit-frequency').value = btn.getAttribute('data-frequency') || '';
      const pri = (btn.getAttribute('data-priority') || '').toLowerCase();
      $('#edit-priority').value = ['low','medium','high'].includes(pri) ? pri : '';
      $('#edit-category').value = btn.getAttribute('data-category') || '';
      const rawDue = btn.getAttribute('data-due-date') || '';
      const due = rawDue ? rawDue.slice(0,10) : '';
      $('#edit-due-date').value = due;
      open(editModal);
    }
  });

  $('#close-history')?.addEventListener('click', () => close(historyModal));
  $('#edit-cancel')?.addEventListener('click', () => close(editModal));

  $('#edit-save')?.addEventListener('click', async () => {
    if(!currentEditTaskId) return;
    const fd = new FormData();
    fd.set('title', $('#edit-title').value.trim());
    fd.set('description', $('#edit-description').value.trim());
    fd.set('frequency_days', $('#edit-frequency').value);
    fd.set('next_due_date', $('#edit-due-date').value);
    fd.set('priority', ($('#edit-priority').value || '').toLowerCase());
    fd.set('category', $('#edit-category').value.trim());
    try {
      const res = await fetch(`${window.location.origin}/edit_task/${currentEditTaskId}`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
        body: fd
      });
      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); } catch(_) {}
      if(!res.ok || (data && data.ok === false)){
        throw new Error((data && data.error) || `Failed to save (${res.status})`);
      }
      window.location.reload();
    } catch(err){
      const errEl = document.getElementById('edit-title-error');
      if(errEl){ errEl.textContent = 'Save failed. Please try again.'; }
    }
  });

  $('#edit-delete')?.addEventListener('click', async () => {
    if(!currentEditTaskId) return;
    if(!window.confirm('Delete this task? This cannot be undone.')) return;
    try {
      const res = await fetch(`${window.location.origin}/delete_task/${currentEditTaskId}`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
      });
      if(!res.ok){ throw new Error('Failed'); }
      window.location.reload();
    } catch(err){
      alert('Failed to delete task.');
    }
  });
})();
</script>
{% endblock %}
